#!/usr/bin/env bash
set -euo pipefail

NIX_SECRETS_DIR="$HOME/github/mgrbyte/nix-secrets"
NIX_CONFIG_DIR="$HOME/github/mgrbyte/nix-config"
AGE_KEY="$HOME/.ssh/id_ed25519_agenix"
AGE_RECIPIENT="ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILmPyaobKItjwejTB0TyS10e4HM/HyvbBRo7Mt9CKysc"

usage() {
    echo "Usage: update-secret <secret-name>"
    echo "  e.g. update-secret netrc-work"
    echo ""
    echo "Available secrets:"
    find "$NIX_SECRETS_DIR" -name '*.age' -exec basename {} .age \; | sort
    exit 1
}

if [[ $# -ne 1 ]]; then
    usage
fi

secret_name="$1"
age_file="$NIX_SECRETS_DIR/${secret_name}.age"

if [[ ! -f "$age_file" ]]; then
    echo "Error: $age_file does not exist"
    usage
fi

tmp_file=$(mktemp "/tmp/${secret_name}.XXXXXX")
trap 'rm -f "$tmp_file"' EXIT

age -d -i "$AGE_KEY" -o "$tmp_file" "$age_file"

checksum_before=$(shasum -a 256 "$tmp_file" | cut -d' ' -f1)

${EDITOR:-emacs -Q -nw} "$tmp_file"

checksum_after=$(shasum -a 256 "$tmp_file" | cut -d' ' -f1)

if [[ "$checksum_before" == "$checksum_after" ]]; then
    echo "No changes made. Aborting."
    exit 0
fi

age -r "$AGE_RECIPIENT" -o "$age_file" "$tmp_file"
echo "Re-encrypted $secret_name"

git -C "$NIX_SECRETS_DIR" add "${secret_name}.age"
git -C "$NIX_SECRETS_DIR" commit -m "Rotate ${secret_name}"
git -C "$NIX_SECRETS_DIR" push
echo "Committed and pushed nix-secrets"

nix flake update nix-secrets --flake "$NIX_CONFIG_DIR"
echo "Updated nix-config flake lock"

echo ""
echo "Secret updated. Run hm-switch to deploy."
